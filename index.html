<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Area Master: Spectator Mode</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@500;700&display=swap');
        
        body { background-color: #050510; color: white; touch-action: none; user-select: none; font-family: 'Roboto Mono', monospace; overflow: hidden; }
        
        .font-display { font-family: 'Black Ops One', cursive; }
        .neon-text { text-shadow: 0 0 10px #22d3ee; }
        
        /* ÂãïÁï´ÊïàÊûú */
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .lane-anim { transition: top 0.5s ease-in-out, width 0.3s linear; position: absolute; left: 0; right: 0; }
        
        .btn-primary { @apply bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg shadow-[0_0_15px_rgba(8,145,178,0.5)] transform transition active:scale-95 w-full mb-3; }
        .btn-option { @apply border border-slate-600 text-slate-400 py-2 px-4 rounded hover:bg-slate-800 focus:bg-cyan-900 focus:text-cyan-400 focus:border-cyan-500 transition-all; }
        .btn-option.selected { @apply bg-cyan-900 text-cyan-400 border-cyan-500 ring-2 ring-cyan-500/50; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center bg-[#050510]">

    <div id="view-menu" class="text-center space-y-6 p-4 max-w-md w-full hidden z-50">
        <h1 class="text-6xl font-display italic text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 mb-2 neon-text leading-tight">MATH<br>ARENA</h1>
        <p class="text-slate-400 text-xs mb-8 tracking-[0.3em]">MULTIPLAYER CLASSROOM BATTLE</p>
        
        <button onclick="setupHost()" class="btn-primary border-l-4 border-cyan-300 text-xl py-6">
            üì° ËÄÅÂ∏´ÈñãÊàø (HOST)
        </button>
        
        <div class="relative py-2 opacity-30"><div class="border-t border-slate-600"></div></div>
        
        <button onclick="startSinglePlayer()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 px-6 rounded w-full">
            üë§ ÂñÆ‰∫∫Á∑¥Áøí
        </button>
    </div>

    <div id="view-host-lobby" class="w-full h-full p-6 hidden flex-col max-w-4xl mx-auto">
        <h2 class="text-3xl text-cyan-400 font-display mb-6 border-b border-slate-700 pb-2">GAME SETTINGS</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full">
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center">
                <div class="bg-white p-2 rounded-lg mb-4 shadow-[0_0_20px_rgba(255,255,255,0.1)]">
                    <div id="qrcode"></div>
                </div>
                <div class="text-2xl font-bold text-white mb-2" id="join-count-display">0 PLAYERS READY</div>
                <p class="text-slate-500 text-sm">Waiting for connections...</p>
                <div id="player-grid" class="mt-4 flex flex-wrap justify-center gap-2 w-full">
                    </div>
            </div>

            <div class="bg-slate-900 p-6 rounded-xl border border-slate-700 flex flex-col">
                <div class="mb-6">
                    <label class="block text-slate-400 text-sm mb-2 font-bold">GAME MODE</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-mode-score" class="btn-option selected" onclick="setMode('score')">üèÅ Á´∂ÈÄü (Race)</button>
                        <button id="btn-mode-time" class="btn-option" onclick="setMode('time')">‚è±Ô∏è ÈôêÊôÇ (Timer)</button>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-slate-400 text-sm mb-2 font-bold" id="setting-label">TARGET SCORE</label>
                    <input type="range" id="setting-slider" min="500" max="3000" step="100" value="1000" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
                    <div class="text-right text-cyan-400 text-2xl font-bold mt-2" id="setting-value">1000 PTS</div>
                </div>

                <div class="mt-auto">
                    <div id="start-warning" class="text-red-500 text-xs text-center mb-2 h-4"></div>
                    <button onclick="hostStartGame()" class="btn-primary bg-gradient-to-r from-green-500 to-emerald-600 text-2xl py-4 shadow-lg">
                        üöÄ START GAME
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-host-game" class="w-full h-full p-4 hidden flex-col bg-slate-950 relative overflow-hidden">
        <div class="flex justify-between items-center mb-4 px-4 py-2 bg-slate-900/80 rounded-lg border border-slate-700">
            <div class="font-display text-2xl italic text-slate-300">LIVE RANKING</div>
            <div class="text-4xl font-mono font-bold text-cyan-400 neon-text" id="host-game-timer">00:00</div>
            <div class="text-sm text-slate-500 font-bold" id="host-target-display">TARGET: 1000</div>
        </div>

        <div class="flex-1 relative mx-4 rounded-xl bg-slate-900/50 border border-slate-800 overflow-hidden" id="lanes-container">
            </div>
    </div>

    <div id="view-join" class="text-center p-6 max-w-md w-full hidden z-50">
        <h2 class="text-2xl font-bold mb-6 text-cyan-400">ENTER NAME</h2>
        <input type="text" id="player-name" placeholder="NICKNAME" maxlength="8" class="w-full p-4 rounded bg-slate-900 border-2 border-slate-700 text-white text-center text-xl mb-4 focus:outline-none focus:border-cyan-500 font-display uppercase tracking-wider">
        <button onclick="joinGameAction()" class="btn-primary">JOIN LOBBY</button>
    </div>

    <div id="view-student-wait" class="text-center p-6 w-full hidden z-50">
        <div class="text-6xl mb-4 animate-bounce">‚è≥</div>
        <h2 class="text-2xl font-bold text-white mb-2">WAITING FOR TEACHER</h2>
        <p class="text-slate-400">The game will start soon...</p>
        <div class="mt-8 p-4 bg-slate-900 rounded border border-slate-700">
            <p class="text-sm text-slate-500">Your Avatar</p>
            <div id="my-avatar-display" class="text-4xl mt-2"></div>
        </div>
    </div>

    <div id="view-game" class="w-full h-full flex flex-col hidden relative bg-slate-900">
        <div class="h-12 bg-slate-950 border-b border-slate-800 flex justify-between items-center px-4">
            <div class="text-cyan-400 font-bold" id="client-score">0 PTS</div>
            <div class="text-slate-400 font-mono" id="client-timer">--:--</div>
        </div>
        
        <div class="flex-1 relative flex justify-center items-center overflow-hidden" id="canvas-container">
            <canvas id="gameCanvas"></canvas>
            <div id="feedback-msg" class="absolute top-1/3 left-1/2 -translate-x-1/2 text-4xl font-black opacity-0 pointer-events-none whitespace-nowrap z-30 transform scale-50 transition-all duration-200" style="-webkit-text-stroke: 1px black;"></div>
        </div>

        <div class="bg-slate-900 border-t border-slate-800 p-2 h-[45vh] grid grid-rows-[auto_1fr] gap-2 z-10 shrink-0">
            <div class="bg-slate-800/50 rounded p-2 flex flex-col justify-center items-center relative border border-slate-700">
                <div class="text-[10px] text-slate-500 absolute top-1 left-2">INPUT</div>
                <div id="input-display" class="text-3xl font-mono font-bold tracking-[0.5em] text-white my-1 min-h-[40px]">_</div>
                <div id="hint-display" class="text-xs text-yellow-500/80 text-center font-mono"></div>
            </div>
            
            <div class="grid grid-cols-3 gap-1 h-full pb-safe">
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('7')">7</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('8')">8</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('9')">9</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('4')">4</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('5')">5</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('6')">6</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('1')">1</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('2')">2</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('3')">3</button>
                <button class="bg-rose-900/40 text-rose-500 rounded font-bold active:bg-rose-900" onclick="input('DEL')">DEL</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('0')">0</button>
                <button class="bg-gradient-to-b from-emerald-600 to-emerald-800 text-white rounded font-bold text-xl active:translate-y-1" onclick="checkAnswer()">GO</button>
            </div>
        </div>
    </div>

    <div id="view-result" class="text-center p-6 w-full hidden z-[100] bg-slate-950/95 absolute inset-0 flex flex-col items-center justify-center">
        <h1 class="text-5xl font-display text-white mb-2 neon-text">GAME OVER</h1>
        <div id="winner-display" class="text-3xl text-yellow-400 mb-8 font-bold animate-pulse"></div>
        
        <div class="w-full max-w-md bg-slate-900 rounded-lg p-4 border border-slate-700 mb-8">
            <div id="final-leaderboard" class="space-y-2"></div>
        </div>
        
        <button onclick="location.href=location.pathname" class="btn-primary max-w-xs">BACK TO MENU</button>
    </div>

<script>
    // ==========================================
    // ‚öôÔ∏è Ë®≠ÂÆöÂçÄ
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyAYnQB2o5cPn42RiNAik7537ihduICJwdQ",
        authDomain: "fwftmath.firebaseapp.com",
        projectId: "fwftmath",
        storageBucket: "fwftmath.firebasestorage.app",
        messagingSenderId: "70090299689",
        appId: "1:70090299689:web:ae300db1f79a3eda62bf38",
        measurementId: "G-PVHYMHY8LK"
    };

    const AVATARS = ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ'];

    // ==========================================
    // Ê†∏ÂøÉÈÇèËºØ
    // ==========================================
    let app, db;
    try { app = firebase.initializeApp(firebaseConfig); db = firebase.database(); } 
    catch(e) { console.error("Firebase Error", e); }

    const urlParams = new URLSearchParams(window.location.search);
    let state = {
        role: 'none', 
        gameId: urlParams.get('gid'),
        playerId: 'p_' + Math.random().toString(36).substr(2, 6),
        playerName: 'Guest', 
        avatar: '',
        score: 0, streak: 0, active: false,
        settings: { mode: 'score', target: 1000 },
        q: null, input: ''
    };

    // Èü≥Êïà
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    function playTone(f, t, d) {
        if(audioCtx.state==='suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type=t; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination);
        o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+d); o.stop(audioCtx.currentTime+d);
    }

    // Áï´Èù¢ÂàáÊèõ
    const views = ['view-menu', 'view-host-lobby', 'view-host-game', 'view-join', 'view-student-wait', 'view-game', 'view-result'];
    function showView(id) {
        views.forEach(v => document.getElementById(v).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'view-host-lobby' || id === 'view-host-game') document.getElementById(id).classList.add('flex');
        if(id === 'view-game') {
            document.getElementById(id).classList.remove('hidden');
            resizeCanvas();
        }
    }

    window.onload = () => {
        if (state.gameId) showView('view-join');
        else showView('view-menu');
    };

    // ==========================================
    // üì° HOST (ËÄÅÂ∏´) ÈÇèËºØ
    // ==========================================
    function setupHost() {
        state.role = 'host';
        const ref = db.ref('games').push();
        state.gameId = ref.key;
        
        // ÂàùÂßãÂåñÈÅäÊà≤Ë®≠ÂÆö
        ref.set({
            status: 'lobby',
            createdAt: Date.now(),
            settings: state.settings
        });

        showView('view-host-lobby');
        
        // QR Code
        const joinUrl = `${window.location.origin}${window.location.pathname}?gid=${state.gameId}`;
        new QRCode(document.getElementById("qrcode"), { text: joinUrl, width: 128, height: 128 });
        
        // Áõ£ËÅΩÁé©ÂÆ∂Âä†ÂÖ•
        db.ref(`games/${state.gameId}/players`).on('value', snap => {
            const grid = document.getElementById('player-grid');
            grid.innerHTML = '';
            let count = 0;
            snap.forEach(c => {
                count++;
                const p = c.val();
                grid.innerHTML += `<div class="bg-slate-800 px-3 py-1 rounded-full border border-slate-600 text-sm animate-[pop_0.3s]">${p.avatar} ${p.name}</div>`;
            });
            document.getElementById('join-count-display').innerText = `${count} PLAYERS READY`;
            state.playerCount = count;
        });

        // Ë®≠ÂÆöÊªëÊ°øÁõ£ËÅΩ
        const slider = document.getElementById('setting-slider');
        slider.oninput = (e) => {
            const val = parseInt(e.target.value);
            state.settings.target = val;
            document.getElementById('setting-value').innerText = state.settings.mode === 'score' ? val + " PTS" : val + " SEC";
            db.ref(`games/${state.gameId}/settings`).update(state.settings);
        };
    }

    function setMode(mode) {
        state.settings.mode = mode;
        const slider = document.getElementById('setting-slider');
        const label = document.getElementById('setting-label');
        
        document.getElementById('btn-mode-score').classList.toggle('selected', mode === 'score');
        document.getElementById('btn-mode-time').classList.toggle('selected', mode === 'time');
        
        if (mode === 'score') {
            label.innerText = "TARGET SCORE";
            slider.min = 500; slider.max = 5000; slider.step = 100; slider.value = 1000;
        } else {
            label.innerText = "TIME LIMIT";
            slider.min = 30; slider.max = 300; slider.step = 10; slider.value = 60;
        }
        slider.oninput({target: slider}); // Trigger update
    }

    function hostStartGame() {
        if ((state.playerCount || 0) < 2) {
             const warning = document.getElementById('start-warning');
             warning.innerText = "‚ö†Ô∏è NEED AT LEAST 2 PLAYERS TO START!";
             setTimeout(()=> warning.innerText = "", 3000);
             return;
        }

        db.ref(`games/${state.gameId}`).update({ 
            status: 'playing', 
            startTime: Date.now(),
            endTime: state.settings.mode === 'time' ? Date.now() + state.settings.target * 1000 : null
        });

        showView('view-host-game');
        document.getElementById('host-target-display').innerText = state.settings.mode === 'score' 
            ? `RACE TO ${state.settings.target} PTS` 
            : `TIME LIMIT: ${state.settings.target}s`;
            
        startHostLoop();
    }

    function startHostLoop() {
        const lanesContainer = document.getElementById('lanes-container');
        
        const loop = setInterval(() => {
            db.ref(`games/${state.gameId}`).once('value', snap => {
                const game = snap.val();
                if (game.status === 'ended') { clearInterval(loop); return; }

                // 1. Update Timer
                let timeStr = "00:00";
                if (game.settings.mode === 'time') {
                    let left = Math.max(0, Math.ceil((game.endTime - Date.now())/1000));
                    timeStr = `${Math.floor(left/60)}:${(left%60).toString().padStart(2,'0')}`;
                    if(left <= 0) hostEndGame();
                } else {
                    let elapsed = Math.floor((Date.now() - game.startTime)/1000);
                    timeStr = `${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`;
                }
                document.getElementById('host-game-timer').innerText = timeStr;

                // 2. Render Lanes
                if(game.players) {
                    const players = Object.values(game.players).sort((a,b) => b.score - a.score);
                    // Check Score Win
                    if (game.settings.mode === 'score' && players[0].score >= game.settings.target) {
                        hostEndGame(players[0]);
                    }

                    // Render
                    renderLanes(players, game.settings.target, game.settings.mode);
                }
            });
        }, 500);
    }

    function renderLanes(players, target, mode) {
        const container = document.getElementById('lanes-container');
        const maxScore = mode === 'score' ? target : Math.max(target, players[0].score * 1.2); // Time mode scales dynamically
        
        // ‰ΩøÁî® map ‰øùÂ≠òÁèæÊúâ DOM ÈÅøÂÖçÈñÉÁàç
        players.forEach((p, index) => {
            let el = document.getElementById(`lane-${p.name}`);
            const pct = Math.min(100, (p.score / maxScore) * 100);
            
            if (!el) {
                el = document.createElement('div');
                el.id = `lane-${p.name}`;
                el.className = 'lane-anim h-12 mb-2 bg-slate-800/50 rounded flex items-center px-2 border border-slate-700 mx-2 shadow';
                el.style.top = (index * 60 + 10) + 'px'; // Absolute positioning for swap animation
                el.innerHTML = `
                    <div class="w-8 text-2xl mr-2">${p.avatar}</div>
                    <div class="w-24 font-bold text-white truncate text-sm">${p.name}</div>
                    <div class="flex-1 h-4 bg-slate-700 rounded-full overflow-hidden mx-2 relative">
                        <div class="bar-fill h-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="w-16 text-right font-mono text-cyan-400 font-bold score-txt">0</div>
                `;
                container.appendChild(el);
            }
            
            // Update Position & Values
            el.style.top = (index * 60 + 10) + 'px';
            el.querySelector('.bar-fill').style.width = pct + '%';
            el.querySelector('.score-txt').innerText = p.score;
            
            // Highlight leader
            if(index === 0) el.classList.add('border-yellow-500');
            else el.classList.remove('border-yellow-500');
        });
    }

    function hostEndGame(winner = null) {
        // If time mode, find winner now
        if (!winner) {
            db.ref(`games/${state.gameId}/players`).once('value', s => {
                const arr = []; s.forEach(c=>arr.push(c.val()));
                arr.sort((a,b)=>b.score-a.score);
                finish(arr[0], arr);
            });
        } else {
            // Fetch all for leaderboard
             db.ref(`games/${state.gameId}/players`).once('value', s => {
                const arr = []; s.forEach(c=>arr.push(c.val()));
                arr.sort((a,b)=>b.score-a.score);
                finish(winner, arr);
            });
        }
        
        function finish(w, all) {
            db.ref(`games/${state.gameId}`).update({ 
                status: 'ended', 
                winnerName: w.name, 
                leaderboard: all.slice(0,5) 
            });
            showResult(w.name, all);
        }
    }

    // ==========================================
    // üì± STUDENT (Áé©ÂÆ∂) ÈÇèËºØ
    // ==========================================
    function joinGameAction() {
        const name = document.getElementById('player-name').value.trim();
        if(!name) return;
        
        state.role = 'client'; 
        state.playerName = name;
        state.avatar = AVATARS[Math.floor(Math.random()*AVATARS.length)];
        
        // ÂØ´ÂÖ•Áé©ÂÆ∂Ë≥áÊñô
        db.ref(`games/${state.gameId}/players/${state.playerId}`).set({
            name: state.playerName, score: 0, avatar: state.avatar
        });

        showView('view-student-wait');
        document.getElementById('my-avatar-display').innerText = state.avatar;

        // Áõ£ËÅΩÈÅäÊà≤ÁãÄÊÖã
        db.ref(`games/${state.gameId}`).on('value', snap => {
            const game = snap.val();
            if(!game) return;
            
            state.settings = game.settings; // Sync settings
            
            if (game.status === 'playing' && !state.active) {
                startGameClient();
            } else if (game.status === 'ended') {
                showResult(game.winnerName, game.leaderboard);
            }
        });
    }

    function startGameClient() {
        state.active = true;
        showView('view-game');
        generateQuestion();
        
        // Client Timer (Simple sync)
        setInterval(() => {
            if(!state.active) return;
            // Just cosmetic timer for client, relying on host for end
            // Optional: Implement robust sync if needed
        }, 1000);
    }

    // ==========================================
    // üß† ÈÅäÊà≤Ê†∏ÂøÉ (Á≠îÈ°åËàáÂàÜÊï∏)
    // ==========================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    function resizeCanvas() {
        const p = document.getElementById('canvas-container');
        canvas.width = p.clientWidth; canvas.height = p.clientHeight;
        if(state.q) drawQuestion();
    }
    window.onresize = resizeCanvas;

    function generateQuestion() {
        if(!state.active) return;
        const r = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        // Èö®ÂàÜÊï∏ÊèêÂçáÈõ£Â∫¶
        let type = 'rect';
        if(state.score > 300) type = Math.random()>0.5 ? 'tri' : 'rect';
        if(state.score > 600) type = Math.random()>0.6 ? 'trap' : 'tri';

        let q = { type, ans: 0 };
        if (type === 'rect') {
            q.w = r(5, 12); q.h = r(4, 9); q.ans = q.w * q.h;
            state.hint = "Area = W √ó H";
        } else if(type === 'tri') {
            q.b = r(6, 14); if(q.b%2!==0)q.b++; q.h = r(4, 10); q.ans = (q.b*q.h)/2;
            state.hint = "Area = B √ó H √∑ 2";
        } else {
             q.t = r(3, 6); q.b = r(q.t+2, 10); if((q.t+q.b)%2!==0)q.b++; q.h = r(4, 8); q.ans = ((q.t+q.b)*q.h)/2;
             state.hint = "Area = (Top+Base)√óH√∑2";
        }
        
        state.q = q; state.input = "";
        document.getElementById('input-display').innerText = "_";
        document.getElementById('hint-display').innerText = state.hint;
        drawQuestion();
    }

    function drawQuestion() {
        const w = canvas.width, h = canvas.height;
        const cx = w/2, cy = h/2, s = Math.min(w,h)/20;
        ctx.clearRect(0,0,w,h);
        
        // Grid
        ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth=1; ctx.beginPath();
        for(let i=0; i<w/2; i+=s) { ctx.moveTo(cx+i,0); ctx.lineTo(cx+i,h); ctx.moveTo(cx-i,0); ctx.lineTo(cx-i,h); }
        for(let i=0; i<h/2; i+=s) { ctx.moveTo(0,cy+i); ctx.lineTo(w,cy+i); ctx.moveTo(0,cy-i); ctx.lineTo(w,cy-i); }
        ctx.stroke();

        ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 3; ctx.fillStyle = 'rgba(34,211,238,0.1)';
        ctx.font = "bold 18px Roboto Mono"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        
        const q = state.q;
        if(q.type === 'rect') {
            const hw=q.w/2*s, hh=q.h/2*s;
            ctx.beginPath(); ctx.rect(cx-hw, cy-hh, q.w*s, q.h*s); ctx.fill(); ctx.stroke();
            label(q.w, cx, cy-hh-20, '#fbbf24'); label(q.h, cx+hw+20, cy, '#4ade80');
        } else if (q.type === 'tri') {
            const hb=q.b/2*s, hh=q.h/2*s;
            ctx.beginPath(); ctx.moveTo(cx, cy-hh); ctx.lineTo(cx-hb, cy+hh); ctx.lineTo(cx+hb, cy+hh); ctx.closePath(); ctx.fill(); ctx.stroke();
            label(q.b, cx, cy+hh+20, '#fbbf24');
            ctx.beginPath(); ctx.setLineDash([4,4]); ctx.moveTo(cx, cy-hh); ctx.lineTo(cx, cy+hh); ctx.stroke(); ctx.setLineDash([]);
            label(q.h, cx+10, cy, '#4ade80');
        } else {
            const ht=q.t/2*s, hb=q.b/2*s, hh=q.h/2*s;
            ctx.beginPath(); ctx.moveTo(cx-ht, cy-hh); ctx.lineTo(cx+ht, cy-hh); ctx.lineTo(cx+hb, cy+hh); ctx.lineTo(cx-hb, cy+hh); ctx.closePath(); ctx.fill(); ctx.stroke();
            label(q.t, cx, cy-hh-20, '#fbbf24'); label(q.b, cx, cy+hh+20, '#fbbf24');
            ctx.beginPath(); ctx.setLineDash([4,4]); ctx.moveTo(cx, cy-hh); ctx.lineTo(cx, cy+hh); ctx.stroke(); ctx.setLineDash([]);
            label(q.h, cx+10, cy, '#4ade80');
        }
    }
    function label(txt, x, y, col) { ctx.fillStyle = '#0f172a'; ctx.fillRect(x-12,y-12,24,24); ctx.fillStyle=col; ctx.fillText(txt,x,y); }

    window.input = (k) => {
        if(!state.active) return;
        if(k === 'DEL') state.input = state.input.slice(0,-1);
        else if(state.input.length < 5) state.input += k;
        document.getElementById('input-display').innerText = state.input || "_";
        playTone(400+(state.input.length*50), 'sine', 0.05);
    };

    window.checkAnswer = () => {
        if(!state.active || !state.input) return;
        const val = parseInt(state.input);
        const feedback = document.getElementById('feedback-msg');
        
        if(val === state.q.ans) {
            state.streak++;
            const pts = 100 + (state.streak >= 3 ? 50 : 0);
            state.score += pts;
            
            playTone(800, 'triangle', 0.1);
            feedback.innerText = "GOOD!"; feedback.style.color = '#4ade80';
            feedback.style.opacity = 1; feedback.style.transform = "translate(-50%,-50%) scale(1.2)";
            
            db.ref(`games/${state.gameId}/players/${state.playerId}`).update({ score: state.score });

            setTimeout(() => {
                feedback.style.opacity = 0; feedback.style.transform = "translate(-50%,-50%) scale(0.5)";
                generateQuestion();
            }, 500);
        } else {
            state.streak = 0;
            playTone(150, 'sawtooth', 0.3);
            feedback.innerText = "MISS"; feedback.style.color = '#ef4444';
            feedback.style.opacity = 1;
            setTimeout(() => { feedback.style.opacity = 0; state.input=""; document.getElementById('input-display').innerText="_";}, 800);
        }
        document.getElementById('client-score').innerText = state.score + " PTS";
    };

    function showResult(winner, list) {
        state.active = false;
        showView('view-result');
        document.getElementById('winner-display').innerText = `üèÜ ${winner} WINS!`;
        
        let html = '';
        if(list) {
            list.slice(0, 5).forEach((p, i) => {
                html += `<div class="flex justify-between p-2 border-b border-slate-700 ${p.name===state.playerName?'text-cyan-400':''}">
                    <span>#${i+1} ${p.avatar} ${p.name}</span><span>${p.score}</span>
                </div>`;
            });
        }
        document.getElementById('final-leaderboard').innerHTML = html;
        playTone(880, 'square', 0.1); setTimeout(()=>playTone(1100, 'square', 0.4), 150);
    }

    window.startSinglePlayer = () => {
        alert("ÂñÆ‰∫∫Ê®°ÂºèÂÉÖ‰æõÁ∑¥ÁøíÔºåË´ã‰ΩøÁî®ËÄÅÂ∏´Ê®°ÂºèÈñãÂïüÂ§ö‰∫∫Â∞çÊà∞ÔºÅ");
        state.role = 'single';
        state.active = true;
        showView('view-game');
        generateQuestion();
    }
</script>
</body>
</html>