<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Arena V13: Stable Host</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@500;700&display=swap');
        
        body { background-color: #050510; color: white; touch-action: none; user-select: none; font-family: 'Roboto Mono', monospace; overflow: hidden; }
        .font-display { font-family: 'Black Ops One', cursive; }
        .neon-text { text-shadow: 0 0 10px #22d3ee; }
        .neon-gold { text-shadow: 0 0 15px #fbbf24; }
        
        .lane-item { position: absolute; left: 0; right: 0; transition: top 0.5s ease-in-out; }
        .progress-bar { transition: width 0.3s linear; }
        
        .btn-primary { @apply bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg shadow-[0_0_15px_rgba(8,145,178,0.5)] transform transition active:scale-95 w-full mb-3; }

        .avatar-btn { @apply text-4xl p-2 rounded-xl border-2 border-transparent transition-all cursor-pointer grayscale opacity-60; }
        .avatar-btn.selected { @apply bg-cyan-500/30 border-cyan-400 grayscale-0 opacity-100 scale-110 shadow-[0_0_15px_rgba(34,211,238,0.3)]; }

        .kick-btn { @apply ml-3 text-red-500 hover:text-red-400 font-bold cursor-pointer px-2 py-1 rounded hover:bg-red-900/30 transition-colors; }

        @keyframes podium-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .podium-enter { animation: podium-up 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .podium-hidden { display: none !important; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center bg-[#050510]">

    <div id="view-menu" class="text-center space-y-6 p-4 max-w-md w-full hidden z-50">
        <h1 class="text-6xl font-display italic text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 mb-2 neon-text">MATH<br>ARENA</h1>
        <p class="text-slate-400 text-xs mb-8 tracking-[0.3em]">MULTIPLAYER BATTLE</p>
        
        <div id="db-status" class="text-xs text-red-500 font-bold mb-4">üî¥ Connecting to Server...</div>
        
        <button onclick="setupHost()" class="btn-primary border-l-4 border-cyan-300 text-xl py-6">üì° HOST GAME</button>
    </div>

    <div id="view-host-lobby" class="w-full h-full p-6 hidden flex-col max-w-4xl mx-auto">
        <h2 class="text-3xl text-cyan-400 font-display mb-6 border-b border-slate-700 pb-2">LOBBY</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full">
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-700 flex flex-col items-center relative">
                <div class="bg-white p-2 rounded-lg mb-4"><div id="qrcode"></div></div>
                <div class="text-2xl font-bold text-white mb-2" id="join-count-display">0 PLAYERS</div>
                <div id="player-grid" class="mt-4 flex flex-wrap justify-center gap-2 w-full max-h-60 overflow-y-auto content-start"></div>
            </div>
            
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-700 flex flex-col">
                <div class="mb-6">
                    <label class="block text-slate-400 text-sm mb-2 font-bold">MODE</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-mode-score" class="border border-slate-600 text-slate-400 py-2 rounded" onclick="setMode('score')">üèÅ Score Race</button>
                        <button id="btn-mode-time" class="border border-cyan-500 text-cyan-400 bg-cyan-900/50 py-2 rounded" onclick="setMode('time')">‚è±Ô∏è Timer Mode</button>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-slate-400 text-sm mb-2 font-bold" id="setting-label">TIME LIMIT</label>
                    <input type="range" id="setting-slider" min="30" max="300" step="10" value="60" class="w-full h-2 bg-slate-700 rounded-lg cursor-pointer accent-cyan-500">
                    <div class="text-right text-cyan-400 text-2xl font-bold mt-2" id="setting-value">60 SEC</div>
                </div>
                <button onclick="hostStartGame()" class="btn-primary mt-auto bg-gradient-to-r from-green-500 to-emerald-600 text-2xl py-4">üöÄ START</button>
            </div>
        </div>
    </div>

    <div id="view-host-game" class="w-full h-full p-4 hidden flex-col bg-slate-950 relative">
        <div class="flex justify-between items-center mb-4 px-4 py-2 bg-slate-900/80 rounded-lg border border-slate-700">
            <div class="font-display text-2xl italic text-slate-300">LIVE RANKING</div>
            <div class="text-4xl font-mono font-bold text-cyan-400 neon-text" id="host-timer-display">00:00</div>
            <div class="text-sm text-slate-500 font-bold" id="host-target-display">TIME LEFT</div>
        </div>
        <div class="flex-1 relative mx-4 rounded-xl bg-slate-900/30 border border-slate-800 overflow-y-auto" id="lanes-container"></div>
        <div id="host-status-msg" class="absolute bottom-10 left-0 w-full text-center pointer-events-none opacity-0 transition-opacity duration-500">
            <span class="bg-black/80 text-yellow-400 px-6 py-2 rounded-full text-xl font-bold border border-yellow-500">CALCULATING RESULTS...</span>
        </div>
    </div>

    <div id="view-join" class="text-center p-6 max-w-md w-full hidden z-50">
        <h2 class="text-2xl font-bold mb-6 text-cyan-400">YOUR NAME</h2>
        <input type="text" id="player-name" placeholder="NAME" maxlength="8" class="w-full p-4 rounded bg-slate-900 border-2 border-slate-700 text-white text-center text-xl mb-4 focus:border-cyan-500 uppercase font-display">
        <button onclick="goToAvatarSelect()" class="btn-primary">NEXT</button>
    </div>

    <div id="view-avatar-select" class="text-center p-6 max-w-md w-full hidden z-50 flex-col">
        <h2 class="text-xl font-bold mb-4 text-cyan-400">SELECT AVATAR</h2>
        <div class="grid grid-cols-4 gap-4 mb-8" id="avatar-grid"></div>
        <button onclick="confirmJoin()" class="btn-primary" id="btn-join-confirm" disabled>READY</button>
        <button onclick="showView('view-join')" class="text-slate-500 underline mt-2">BACK</button>
    </div>

    <div id="view-student-wait" class="text-center p-6 w-full hidden z-50">
        <div class="text-6xl mb-4 animate-bounce">‚è≥</div>
        <h2 class="text-2xl font-bold text-white mb-2">WAITING...</h2>
        <div class="mt-8 p-4 bg-slate-900 rounded border border-slate-700 flex flex-col items-center">
            <div id="my-final-avatar" class="text-5xl mb-2"></div>
            <span id="my-final-name" class="font-bold text-cyan-400"></span>
        </div>
    </div>

    <div id="view-game" class="w-full h-full flex flex-col hidden relative bg-slate-900">
        <div id="game-freeze-overlay" class="absolute inset-0 bg-slate-950/95 z-40 hidden flex flex-col items-center justify-center">
            <div class="text-6xl mb-4">üõë</div>
            <h2 class="text-4xl font-display text-red-500 mb-2 neon-text">TIME UP!</h2>
            <p class="text-white animate-pulse">Waiting for Host...</p>
        </div>
        <div class="h-12 bg-slate-950 border-b border-slate-800 flex justify-between items-center px-4">
            <div class="text-cyan-400 font-bold" id="client-score">0 PTS</div>
            <div class="text-slate-400 font-mono" id="client-timer-display">--:--</div>
        </div>
        <div class="flex-1 relative flex justify-center items-center" id="canvas-container">
            <canvas id="gameCanvas"></canvas>
            <div id="feedback-msg" class="absolute top-1/3 left-1/2 -translate-x-1/2 text-4xl font-black opacity-0 pointer-events-none z-30"></div>
        </div>
        <div class="bg-slate-900 border-t border-slate-800 p-2 h-[45vh] grid grid-rows-[auto_1fr] gap-2 z-10 shrink-0">
            <div class="bg-slate-800/50 rounded p-2 flex flex-col justify-center items-center relative border border-slate-700">
                <div id="input-display" class="text-3xl font-mono font-bold tracking-[0.5em] text-white">_</div>
                <div id="hint-display" class="text-xs text-yellow-500/80 font-mono"></div>
            </div>
            <div class="grid grid-cols-3 gap-1 h-full pb-safe">
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('7')">7</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('8')">8</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('9')">9</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('4')">4</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('5')">5</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('6')">6</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('1')">1</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('2')">2</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('3')">3</button>
                <button class="bg-rose-900/40 text-rose-500 rounded font-bold active:bg-rose-900" onclick="input('DEL')">DEL</button>
                <button class="bg-slate-800 text-cyan-100 rounded text-2xl font-bold active:bg-cyan-700" onclick="input('0')">0</button>
                <button class="bg-gradient-to-b from-emerald-600 to-emerald-800 text-white rounded font-bold text-xl active:translate-y-1" onclick="checkAnswer()">GO</button>
            </div>
        </div>
    </div>

    <div id="view-podium" class="text-center w-full hidden z-[100] bg-slate-950 absolute inset-0 flex flex-col items-center justify-center">
        <h1 class="text-5xl font-display text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-12 neon-gold z-10">CHAMPIONS</h1>
        <div class="flex items-end justify-center space-x-2 md:space-x-4 mb-12 w-full max-w-3xl px-4 z-10" id="podium-container">
            <div id="podium-2" class="flex flex-col items-center podium-hidden opacity-0" style="animation-delay: 0.5s">
                <div class="text-4xl mb-2" id="p2-avatar"></div>
                <div class="text-white font-bold text-sm" id="p2-name"></div>
                <div class="w-20 md:w-32 h-32 bg-slate-700 rounded-t-lg border-t-4 border-slate-400 flex items-end justify-center pb-2 shadow-lg">
                    <span class="text-3xl font-black text-slate-500">2</span>
                </div>
                <div class="mt-2 text-cyan-400 font-bold" id="p2-score"></div>
            </div>
            <div id="podium-1" class="flex flex-col items-center podium-enter opacity-0" style="animation-delay: 1.5s">
                <div class="text-7xl mb-2 animate-bounce" id="p1-avatar"></div>
                <div class="text-yellow-400 font-bold text-xl neon-gold" id="p1-name"></div>
                <div class="w-24 md:w-40 h-48 bg-gradient-to-b from-yellow-600 to-yellow-800 rounded-t-lg border-t-4 border-yellow-400 flex items-end justify-center pb-4 shadow-[0_0_30px_rgba(234,179,8,0.4)] z-20">
                    <span class="text-5xl font-black text-yellow-900/50">1</span>
                </div>
                <div class="mt-2 text-yellow-400 text-2xl font-black" id="p1-score"></div>
            </div>
            <div id="podium-3" class="flex flex-col items-center podium-hidden opacity-0" style="animation-delay: 1.0s">
                <div class="text-4xl mb-2" id="p3-avatar"></div>
                <div class="text-white font-bold text-sm" id="p3-name"></div>
                <div class="w-20 md:w-32 h-24 bg-orange-900 rounded-t-lg border-t-4 border-orange-700 flex items-end justify-center pb-2 shadow-lg">
                    <span class="text-3xl font-black text-orange-900/50">3</span>
                </div>
                <div class="mt-2 text-cyan-400 font-bold" id="p3-score"></div>
            </div>
        </div>
        <button onclick="location.href=location.pathname" class="btn-primary max-w-xs z-20">NEW GAME</button>
    </div>

<script>
    // ======================================
    // Firebase ÂàùÂßãÂåñ (Âê´ÈåØË™§ËôïÁêÜ)
    // ======================================
    const firebaseConfig = {
        apiKey: "AIzaSyAYnQB2o5cPn42RiNAik7537ihduICJwdQ",
        authDomain: "fwftmath.firebaseapp.com",
        projectId: "fwftmath",
        storageBucket: "fwftmath.firebasestorage.app",
        messagingSenderId: "70090299689",
        appId: "1:70090299689:web:ae300db1f79a3eda62bf38"
    };

    let app, db;
    
    // Ê™¢Êü• Firebase ÊòØÂê¶ÊàêÂäüËºâÂÖ•
    window.addEventListener('load', () => {
        const statusEl = document.getElementById('db-status');
        try {
            if (typeof firebase === 'undefined') throw new Error("Firebase SDK failed to load");
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            
            // Ê∏¨Ë©¶ÈÄ£Á∑ö
            const connectedRef = db.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    if(statusEl) {
                        statusEl.innerText = "üü¢ SERVER CONNECTED";
                        statusEl.className = "text-xs text-green-400 font-bold mb-4";
                    }
                } else {
                    if(statusEl) statusEl.innerText = "üü† CONNECTING...";
                }
            });
            
        } catch (e) {
            console.error(e);
            if(statusEl) statusEl.innerText = "‚ùå SERVER ERROR: " + e.message;
            alert("Critical Error: Firebase not loaded. Please check internet connection.");
        }
    });

    const AVATAR_OPTIONS = ['üêØ','üê∞','ü¶Å','ü¶Ñ','ü¶ñ','üëΩ','ü§ñ','üêº'];
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(f,t,d){if(audioCtx.state==='suspended')audioCtx.resume();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=t;o.frequency.value=f;o.connect(g);g.connect(audioCtx.destination);o.start();g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+d);o.stop(audioCtx.currentTime+d);}

    const urlParams = new URLSearchParams(window.location.search);
    let state = {
        role: 'none', gameId: urlParams.get('gid'),
        playerId: 'p_' + Math.random().toString(36).substr(2,6),
        playerName: 'Guest', avatar: '',
        score: 0, active: false,
        settings: { mode: 'time', target: 60 },
        q: null, input: '',
        endTime: 0
    };
    let localTimerInterval = null;

    const views = ['view-menu','view-host-lobby','view-host-game','view-join','view-avatar-select','view-student-wait','view-game','view-podium'];
    function showView(id) {
        views.forEach(v => document.getElementById(v).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id.includes('host') || id === 'view-avatar-select') document.getElementById(id).classList.add('flex');
        if(id === 'view-game') resizeCanvas();
    }

    window.onload = () => {
        if(state.gameId) showView('view-join');
        else showView('view-menu');
    };

    // ======================================
    // HOST ÈÇèËºØ (‰øÆÂæ©Áâà)
    // ======================================
    function setupHost() {
        if (!db) {
            alert("Database not ready yet. Please wait for the green 'CONNECTED' light.");
            return;
        }

        try {
            state.role = 'host';
            
            // 1. ÂÖàÂàáÊèõÁï´Èù¢ÔºåËÆì‰ΩøÁî®ËÄÖÊúâÂèçÈ•ã
            showView('view-host-lobby');

            // 2. Âª∫Á´ãÈÅäÊà≤
            const ref = db.ref('games').push();
            state.gameId = ref.key;
            setMode('time');
            ref.set({ status: 'lobby', createdAt: Date.now(), settings: state.settings });
            
            // 3. ÁîüÊàê QR Code
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = ""; // Ê∏ÖÁ©∫ËàäÁöÑ
            new QRCode(qrContainer, { text: `${location.origin}${location.pathname}?gid=${state.gameId}`, width: 128, height: 128 });
            
            // 4. Áõ£ËÅΩÁé©ÂÆ∂
            db.ref(`games/${state.gameId}/players`).on('value', snap => {
                const grid = document.getElementById('player-grid');
                grid.innerHTML = '';
                let count = 0;
                snap.forEach(c => {
                    count++;
                    const p = c.val();
                    const div = document.createElement('div');
                    div.className = "bg-slate-800 px-3 py-2 rounded-lg border border-slate-600 text-sm flex items-center gap-2 animate-[pop_0.3s]";
                    div.innerHTML = `<span class="text-xl">${p.avatar}</span><span class="font-bold text-white">${p.name}</span><button onclick="kickPlayer('${c.key}')" class="kick-btn">‚ùå</button>`;
                    grid.appendChild(div);
                });
                document.getElementById('join-count-display').innerText = `${count} PLAYERS`;
            });

            // 5. Á∂ÅÂÆöË®≠ÂÆöÊªëÊ°ø
            const slider = document.getElementById('setting-slider');
            slider.oninput = (e) => {
                state.settings.target = parseInt(e.target.value);
                document.getElementById('setting-value').innerText = state.settings.mode==='score' ? state.settings.target+" PTS" : state.settings.target+" SEC";
                // Âè™ÊúâÂú® gameId Â≠òÂú®ÊôÇÊâçÂØ´ÂÖ•
                if(state.gameId) db.ref(`games/${state.gameId}/settings`).update(state.settings);
            };

        } catch (err) {
            console.error("Host Setup Error:", err);
            alert("Error creating game: " + err.message);
            location.reload(); // ÈáçÊï¥È†ÅÈù¢
        }
    }

    window.kickPlayer = (pid) => { if(confirm("Kick player?")) db.ref(`games/${state.gameId}/players/${pid}`).remove(); };

    function setMode(mode) {
        state.settings.mode = mode;
        const slider = document.getElementById('setting-slider');
        document.getElementById('btn-mode-score').className = mode==='score' ? "border border-cyan-500 text-cyan-400 bg-cyan-900/50 py-2 rounded" : "border border-slate-600 text-slate-400 py-2 rounded";
        document.getElementById('btn-mode-time').className = mode==='time' ? "border border-cyan-500 text-cyan-400 bg-cyan-900/50 py-2 rounded" : "border border-slate-600 text-slate-400 py-2 rounded";
        if(mode==='score') { document.getElementById('setting-label').innerText="TARGET SCORE"; slider.min=500; slider.max=5000; slider.step=100; slider.value=1000; } 
        else { document.getElementById('setting-label').innerText="TIME LIMIT"; slider.min=30; slider.max=300; slider.step=10; slider.value=60; }
        
        // Ëß∏ÁôºÊõ¥Êñ∞
        if(state.gameId) slider.oninput({target:slider});
    }

    function hostStartGame() {
        const updateData = { status: 'playing', startTime: Date.now() };
        if(state.settings.mode === 'time') {
            state.endTime = Date.now() + (state.settings.target * 1000);
            updateData.endTime = state.endTime;
        }
        db.ref(`games/${state.gameId}`).update(updateData);
        showView('view-host-game');
        document.getElementById('host-target-display').innerText = state.settings.mode==='score' ? `TARGET: ${state.settings.target}` : "TIME LEFT";
        
        startLocalTicker(state.settings.mode === 'time' ? state.endTime : null, 'host-timer-display');
        monitorGameLoop();
    }

    function monitorGameLoop() {
        const gameRef = db.ref(`games/${state.gameId}`);
        gameRef.on('value', snap => {
            const game = snap.val();
            if(!game) return;

            if (game.status === 'playing') {
                if (game.settings.mode === 'time' && state.role === 'host') {
                    const left = Math.ceil((game.endTime - Date.now())/1000);
                    if(left <= 0) executeGameFinish();
                }
            } else if (game.status === 'results') {
                showPodium(game.leaderboard);
                gameRef.off();
            }

            if(game.players) {
                const players = Object.values(game.players).sort((a,b)=>(b.score||0)-(a.score||0));
                if (state.role==='host' && game.status==='playing' && game.settings.mode==='score') {
                    if(players[0].score >= game.settings.target) executeGameFinish();
                }
                renderLanes(players, game.settings.target, game.settings.mode);
            }
        });
    }

    function executeGameFinish() {
        db.ref(`games/${state.gameId}`).update({ status: 'calculating' });
        document.getElementById('host-status-msg').style.opacity = 1;
        if(localTimerInterval) clearInterval(localTimerInterval);

        setTimeout(() => {
            db.ref(`games/${state.gameId}/players`).once('value', s => {
                const arr = [];
                s.forEach(c => arr.push(c.val()));
                arr.sort((a,b) => (parseInt(b.score)||0) - (parseInt(a.score)||0));
                db.ref(`games/${state.gameId}`).update({ status: 'results', leaderboard: arr.slice(0, 3) });
            });
        }, 1500);
    }

    function renderLanes(players, target, mode) {
        const container = document.getElementById('lanes-container');
        const maxScore = mode==='score' ? target : Math.max(target*5, (players[0].score||0)*1.2);
        
        players.forEach((p, index) => {
            let el = document.getElementById(`lane-${p.name}`);
            const pct = Math.min(100, ((p.score||0)/maxScore)*100);
            if (!el) {
                el = document.createElement('div');
                el.id = `lane-${p.name}`;
                el.className = 'lane-item h-12 bg-slate-800/80 rounded flex items-center px-2 border border-slate-700 shadow mx-2';
                el.style.width = "calc(100% - 32px)";
                el.innerHTML = `
                    <div class="w-10 text-2xl mr-2 text-center">${p.avatar}</div>
                    <div class="w-24 font-bold text-white truncate text-sm">${p.name}</div>
                    <div class="flex-1 h-4 bg-slate-900 rounded-full overflow-hidden mx-2 border border-slate-600">
                        <div class="progress-bar h-full bg-gradient-to-r from-cyan-500 to-blue-500" style="width: 0%"></div>
                    </div>
                    <div class="w-16 text-right font-mono text-cyan-400 font-bold score-txt">0</div>
                `;
                container.appendChild(el);
            }
            el.style.top = (index * 60 + 10) + 'px';
            el.querySelector('.progress-bar').style.width = pct + '%';
            el.querySelector('.score-txt').innerText = p.score || 0;
            if(index===0) el.classList.add('border-yellow-500'); else el.classList.remove('border-yellow-500');
        });
    }

    // ======================================
    // CLIENT ÈÇèËºØ
    // ======================================
    function goToAvatarSelect() {
        const name = document.getElementById('player-name').value.trim();
        if(!name) return alert("Enter Name!");
        state.playerName = name;
        const grid = document.getElementById('avatar-grid');
        grid.innerHTML = '';
        AVATAR_OPTIONS.forEach(av => {
            const btn = document.createElement('div');
            btn.className = 'avatar-btn';
            btn.innerText = av;
            btn.onclick = () => {
                document.querySelectorAll('.avatar-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                state.avatar = av;
                document.getElementById('btn-join-confirm').disabled = false;
            };
            grid.appendChild(btn);
        });
        showView('view-avatar-select');
    }

    function confirmJoin() {
        if(!db) return alert("Connecting to server...");
        const playerRef = db.ref(`games/${state.gameId}/players/${state.playerId}`);
        playerRef.set({ name: state.playerName, score: 0, avatar: state.avatar });
        playerRef.on('value', snap => { if(!snap.exists() && state.role !== 'host') location.reload(); });

        showView('view-student-wait');
        document.getElementById('my-final-avatar').innerText = state.avatar;
        document.getElementById('my-final-name').innerText = state.playerName;

        db.ref(`games/${state.gameId}`).on('value', snap => {
            const game = snap.val();
            if(!game) return;
            state.settings = game.settings;
            
            if (game.status === 'playing') {
                document.getElementById('game-freeze-overlay').classList.add('hidden');
                if (!state.active) {
                    state.active = true;
                    showView('view-game');
                    generateQuestion();
                    startLocalTicker(game.endTime, 'client-timer-display');
                }
            } 
            else if (game.status === 'calculating' || game.status === 'finished') {
                state.active = false;
                if(localTimerInterval) clearInterval(localTimerInterval);
                document.getElementById('game-freeze-overlay').classList.remove('hidden');
            }
            else if (game.status === 'results') {
                showPodium(game.leaderboard);
            }
        });
    }

    function startLocalTicker(endTime, elementId) {
        if(localTimerInterval) clearInterval(localTimerInterval);
        const el = document.getElementById(elementId);
        updateTime();
        localTimerInterval = setInterval(updateTime, 200);

        function updateTime() {
            if(!endTime) { el.innerText = "RACE"; return; }
            const now = Date.now();
            const left = Math.ceil((endTime - now) / 1000);
            if(left <= 0) {
                el.innerText = "00:00";
                if(state.role !== 'host') clearInterval(localTimerInterval);
                return;
            }
            const m = Math.floor(left / 60);
            const s = left % 60;
            el.innerText = `${m}:${s.toString().padStart(2, '0')}`;
        }
    }

    // ======================================
    // È†íÁçéÂè∞
    // ======================================
    function showPodium(leaders) {
        state.active = false;
        if(localTimerInterval) clearInterval(localTimerInterval);
        showView('view-podium');
        const end = Date.now() + 3000;
        (function frame() {
            confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 } });
            confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 } });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());

        const setP = (rank, p) => {
            const el = document.getElementById(`podium-${rank}`);
            if(!p) {
                el.classList.add('podium-hidden');
                el.classList.remove('podium-enter');
                return;
            }
            el.classList.remove('podium-hidden');
            el.classList.add('podium-enter');
            document.getElementById(`p${rank}-name`).innerText = p.name;
            document.getElementById(`p${rank}-avatar`).innerText = p.avatar;
            document.getElementById(`p${rank}-score`).innerText = p.score;
        };

        if(!leaders) leaders = [];
        setP(1, leaders[0]);
        setP(2, leaders[1]);
        setP(3, leaders[2]);
    }

    // ======================================
    // ÈÅäÊà≤È°åÁõÆËàáÈÇèËºØ
    // ======================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    function resizeCanvas() {
        const p = document.getElementById('canvas-container');
        if(!p) return;
        canvas.width = p.clientWidth; canvas.height = p.clientHeight;
        if(state.q) drawQuestion();
    }
    window.onresize = resizeCanvas;

    function generateQuestion() {
        if(!state.active) return;
        const r = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        let type = 'rect';
        if(state.score > 300) type = Math.random()>0.5 ? 'tri' : 'rect';
        let q = { type, ans: 0 };
        if (type === 'rect') {
            q.w = r(5, 12); q.h = r(4, 9); q.ans = q.w * q.h;
            state.hint = "Area = W √ó H";
        } else {
            q.b = r(6, 14); if(q.b%2!==0)q.b++; q.h = r(4, 10); q.ans = (q.b*q.h)/2;
            state.hint = "Area = B √ó H √∑ 2";
        }
        state.q = q; state.input = "";
        document.getElementById('input-display').innerText = "_";
        drawQuestion();
    }

    function drawQuestion() {
        const w = canvas.width, h = canvas.height;
        const cx = w/2, cy = h/2, s = Math.min(w,h)/18;
        ctx.clearRect(0,0,w,h);
        ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 3; ctx.fillStyle = 'rgba(34,211,238,0.1)';
        ctx.font = "bold 20px Roboto Mono"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        if(state.q.type === 'rect') {
            const hw=state.q.w/2*s, hh=state.q.h/2*s;
            ctx.beginPath(); ctx.rect(cx-hw, cy-hh, state.q.w*s, state.q.h*s); ctx.fill(); ctx.stroke();
            label(state.q.w, cx, cy-hh-20, '#fbbf24'); label(state.q.h, cx+hw+20, cy, '#4ade80');
        } else {
            const hb=state.q.b/2*s, hh=state.q.h/2*s;
            ctx.beginPath(); ctx.moveTo(cx, cy-hh); ctx.lineTo(cx-hb, cy+hh); ctx.lineTo(cx+hb, cy+hh); ctx.closePath(); ctx.fill(); ctx.stroke();
            label(state.q.b, cx, cy+hh+20, '#fbbf24');
            ctx.beginPath(); ctx.setLineDash([4,4]); ctx.moveTo(cx, cy-hh); ctx.lineTo(cx, cy+hh); ctx.stroke(); ctx.setLineDash([]);
            label(state.q.h, cx+10, cy, '#4ade80');
        }
    }
    function label(txt, x, y, col) { ctx.fillStyle = '#0f172a'; ctx.fillRect(x-12,y-12,24,24); ctx.fillStyle=col; ctx.fillText(txt,x,y); }

    window.input = (k) => {
        if(!state.active) return;
        if(k === 'DEL') state.input = state.input.slice(0,-1);
        else if(state.input.length < 5) state.input += k;
        document.getElementById('input-display').innerText = state.input || "_";
        playTone(400+(state.input.length*50), 'sine', 0.05);
    };

    window.checkAnswer = () => {
        if(!state.active || !state.input) return;
        const val = parseInt(state.input);
        const feedback = document.getElementById('feedback-msg');
        if(val === state.q.ans) {
            state.score += 100;
            playTone(800, 'triangle', 0.1);
            feedback.innerText = "GOOD!"; feedback.style.color = '#4ade80';
            feedback.style.opacity = 1; feedback.style.transform = "translate(-50%,-50%) scale(1.2)";
            db.ref(`games/${state.gameId}/players/${state.playerId}`).update({ score: state.score });
            setTimeout(() => { feedback.style.opacity = 0; generateQuestion(); }, 400);
        } else {
            playTone(150, 'sawtooth', 0.3);
            feedback.innerText = "MISS"; feedback.style.color = '#ef4444';
            feedback.style.opacity = 1;
            setTimeout(() => { feedback.style.opacity = 0; state.input=""; document.getElementById('input-display').innerText="_"; }, 500);
        }
        document.getElementById('client-score').innerText = state.score + " PTS";
    };
</script>
</body>
</html>